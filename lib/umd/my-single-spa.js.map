{"version":3,"file":"my-single-spa.js","sources":["../../src/applications/timeouts.js","../../src/applications/app.helper.js","../../src/lifecycles/bootstrap.js","../../src/lifecycles/unmount.js","../../src/lifecycles/mount.js","../../src/lifecycles/update.js","../../src/services/index.js","../../src/lifecycles/helper.js","../../src/lifecycles/load.js","../../src/start.js","../../src/navigation/hijackLocation.js","../../src/navigation/invoke.js","../../src/applications/apps.js"],"sourcesContent":["'use strict';\n\nconst DEFAULT_TIMEOUTS = {\n  bootstrap: {\n    // 超时毫秒数\n    milliseconds: 3000,\n    // 当超时时，是否 reject\n    rejectWhenTimeout: false,\n  },\n  mount: {\n    // 超时毫秒数\n    milliseconds: 3000,\n    // 当超时时，是否 reject\n    rejectWhenTimeout: false,\n  },\n  unmount: {\n    // 超时毫秒数\n    milliseconds: 3000,\n    // 当超时时，是否 reject\n    rejectWhenTimeout: false,\n  },\n  unload: {\n    // 超时毫秒数\n    milliseconds: 3000,\n    // 当超时时，是否 reject\n    rejectWhenTimeout: false,\n  },\n};\n\nexport function setBootstrapMaxTime(milliseconds, rejectWhenTimeout = false) {\n  if (typeof milliseconds !== 'number' || milliseconds <= 0) {\n    throw new Error(`${type} max time must be a positive integer number of milliseconds`);\n  }\n  DEFAULT_TIMEOUTS.bootstrap = { milliseconds, rejectWhenTimeout, };\n}\n\nexport function setMountMaxTime(milliseconds, rejectWhenTimeout = false) {\n  if (typeof milliseconds !== 'number' || milliseconds <= 0) {\n    throw new Error(`${type} max time must be a positive integer number of milliseconds`);\n  }\n  DEFAULT_TIMEOUTS.mount = { milliseconds, rejectWhenTimeout, };\n}\n\nexport function setUnmountMaxTime(milliseconds, rejectWhenTimeout = false) {\n  if (typeof milliseconds !== 'number' || milliseconds <= 0) {\n    throw new Error(`${type} max time must be a positive integer number of milliseconds`);\n  }\n  DEFAULT_TIMEOUTS.unmount = { milliseconds, rejectWhenTimeout, };\n}\n\nexport function setUnloadMaxTime(milliseconds, rejectWhenTimeout = false) {\n  if (typeof milliseconds !== 'number' || milliseconds <= 0) {\n    throw new Error(`${type} max time must be a positive integer number of milliseconds`);\n  }\n  DEFAULT_TIMEOUTS.unload = { milliseconds, rejectWhenTimeout, };\n}\n\nexport function ensureAppTimeouts(timeouts = {}) {\n  return {\n    ...DEFAULT_TIMEOUTS,\n    ...timeouts,\n  };\n}\n\n/**\n * 给每个app的生命周期函数增加超时的处理\n * promise： 经过 flattenFnArray 处理过的生命周期函数\n */\nexport function reasonableTime(promise, description, timeouts) {\n  return new Promise((resolve, reject) => {\n    let finised = false;\n\n    promise.then(data => {\n      finised = true;\n      resolve(data);\n    }).catch(e => {\n      finised = true;\n      reject(e);\n    });\n\n    setTimeout(() => maybeTimeout(), timeouts.milliseconds);\n\n    function maybeTimeout() {\n      if (finised) {\n        return;\n      }\n\n      let error = `${description} did not resolve or reject for ${timeouts.milliseconds} milliseconds`;\n      if (timeouts.rejectWhenTimeout) {\n        reject(new Error(error));\n      } else {\n        console.error(error);\n      }\n    }\n  });\n}","'use strict';\n\n// 未加载\n// app还未加载，默认状态\nexport const NOT_LOADED = 'NOT_LOADED';\n\n// 加载 app 代码中\nexport const LOAD_RESOURCE_CODE = 'LOAD_RESOURCE_CODE';\n\n// 加载成功，但未启动\n// app模块加载完成，但是还未启动（未执行app的bootstrap生命周期函数）\nexport const NOT_BOOTSTRAPPED = 'NOT_BOOTSTRAPPED';\n\n// 启动中\n// 执行app的bootstrap生命周期函数中（只执行一次）\nexport const BOOTSTRAPPING = 'BOOTSTRAPPING';\n\n// 启动成功，但未挂载\n// app的bootstrap或unmount生命周期函数执行成功，等待执行mount生命周期函数（可多次执行）\nexport const NOT_MOUNTED = 'NOT_MOUNTED';\n\n// 挂载中\n// 执行app的mount生命周期函数中\nexport const MOUNTING = 'MOUNTING';\n\n// 挂载成功\n// app的mount或update(service独有)生命周期函数执行成功，意味着此app已挂载成功，可执行Vue的$mount()或ReactDOM的render()\nexport const MOUNTED = 'MOUNTED';\n\n// 卸载中\n// \tapp的unmount生命周期函数执行中，意味着此app正在卸载中，可执行Vue的$destory()或ReactDOM的unmountComponentAtNode()\nexport const UNMOUNTING = 'UNMOUNTING';\n\n// 加载时参数校验未通过，或非致命错误\n// app变更状态时遇见错误，如果app的状态变为了SKIP_BECAUSE_BROKEN，那么app就会blocking，不会往下个状态变更\nexport const SKIP_BECAUSE_BROKEN = 'SKIP_BECAUSE_BROKEN';\n\n// 加载时遇到致命错误\n// 加载错误，意味着app将无法被使用\nexport const LOAD_ERROR = 'LOAD_ERROR';\n\n// 更新 service 中\n// service更新中，只有service才会有此状态，app则没有\nexport const UPDATING = 'UPDATING';\n\nexport function notSkipped(app) {\n  return app.status !== SKIP_BECAUSE_BROKEN;\n}\n\nexport function withoutLoadError(app) {\n  return app.status !== LOAD_ERROR;\n}\n\nexport function isLoaded(app) {\n  return app.status !== NOT_LOADED && app.status !== LOAD_ERROR && app.status !== LOAD_RESOURCE_CODE;\n}\n\nexport function isntLoaded(app) {\n  return !isLoaded(app);\n}\n\nexport function isActive(app) {\n  return app.status === MOUNTED;\n}\n\nexport function isntActive(app) {\n  return !isActive(app);\n}\n\nexport function shouldBeActive(app) {\n  try {\n    return app.activityWhen(window.location);\n  } catch (e) {\n    app.status = SKIP_BECAUSE_BROKEN;\n    throw e;\n  }\n}\n\nexport function shouldntBeActive(app) {\n  try {\n    return !app.activityWhen(window.location);\n  } catch (e) {\n    app.status = SKIP_BECAUSE_BROKEN;\n    throw e;\n  }\n}","'use strict';\n\nimport {\n  NOT_BOOTSTRAPPED,\n  BOOTSTRAPPING,\n  NOT_MOUNTED,\n  SKIP_BECAUSE_BROKEN,\n} from '../applications/app.helper';\nimport { reasonableTime } from '../applications/timeouts';\nimport { getProps } from './helper';\n\n/**\n * 启动 app\n *\n * @export\n * @param {*} app\n * @returns\n */\nexport function toBootstrapPromise(app) {\n  if (app.status !== NOT_BOOTSTRAPPED) {\n    return Promise.resolve(app);\n  }\n\n  app.status = BOOTSTRAPPING;\n\n  return reasonableTime(app.bootstrap(getProps(app)), `app: ${app.name} bootstraping`, app.timeouts.bootstrap).then(() => {\n    app.status = NOT_MOUNTED;\n    return app;\n  }).catch(e => {\n    console.log(e);\n    app.status = SKIP_BECAUSE_BROKEN;\n    return app;\n  });\n}","'use strict';\n\nimport {\n  MOUNTED,\n  NOT_MOUNTED,\n  SKIP_BECAUSE_BROKEN,\n  UNMOUNTING,\n} from '../applications/app.helper';\nimport { reasonableTime } from '../applications/timeouts';\nimport { getProps } from './helper';\n\n/**\n * 卸载 app\n *\n * @export\n * @param {*} app\n * @returns\n */\nexport function toUnmountPromise(app) {\n  if (app.status !== MOUNTED) {\n    return Promise.resolve(app);\n  }\n\n  app.status = UNMOUNTING;\n\n  function unmountThisApp(serviceUnmountError) {\n    return reasonableTime(app.unmount(getProps(app)), `app: ${app.name} unmounting`, app.timeouts.unmount).catch(e => {\n      console.log(e);\n      app.status = SKIP_BECAUSE_BROKEN;\n    }).then(() => {\n      if (app.status !== SKIP_BECAUSE_BROKEN) {\n        app.status = serviceUnmountError === true ? SKIP_BECAUSE_BROKEN : NOT_MOUNTED;\n      }\n      return app;\n    });\n  }\n\n  // 优先卸载当前 app 中的 service，如果存在的话\n  let unmountServicePromise = Promise.all(Object.keys(app.services).map(name => app.services[name].unmountSelf()));\n\n  return unmountServicePromise.catch(e => {\n    console.log(e);\n    return true;\n  }).then(unmountThisApp);\n}","'use strict';\n\nimport {\n  MOUNTED,\n  NOT_MOUNTED,\n  SKIP_BECAUSE_BROKEN,\n  MOUNTING,\n} from '../applications/app.helper';\nimport { reasonableTime } from '../applications/timeouts';\nimport { getProps } from './helper';\nimport { toUnmountPromise } from './unmount';\n\n/**\n * 挂载 app\n *\n * @export\n * @param {*} app\n * @returns\n */\nexport function toMountPromise(app) {\n  if (app.status !== NOT_MOUNTED) {\n    return Promise.resolve(app);\n  }\n\n  app.status = MOUNTING;\n  return reasonableTime(app.mount(getProps(app)), `app: ${app.name} mounting`, app.timeouts.mount).then(() => {\n    app.status = MOUNTED;\n  }).catch(e => {\n    console.log(e);\n    app.status = MOUNTED;\n\n    return toUnmountPromise(app).catch(e => {\n      console.log(e);\n    }).then(() => {\n      app.status = SKIP_BECAUSE_BROKEN;\n      return app;\n    });\n  });\n}","'use strict';\n\nimport {\n  MOUNTED,\n  SKIP_BECAUSE_BROKEN,\n  UPDATING,\n} from '../applications/app.helper';\nimport { reasonableTime } from '../applications/timeouts';\nimport { getProps } from './helper';\n\n/**\n * 更新 service\n *\n * @export\n * @param {*} service\n * @returns\n */\nexport function toUpdatePromise(service) {\n  if (service.status !== MOUNTED) {\n    return Promise.resolve(service);\n  }\n\n  service.status = UPDATING;\n  return reasonableTime(service.update(getProps(service)), `service: ${service.name} updating`, service.timeouts.mount).then(() => {\n    service.status = MOUNTED;\n    return service;\n  }).catch(e => {\n    console.log(e);\n    service.status = SKIP_BECAUSE_BROKEN;\n    return service;\n  });\n}","'use strict';\n\nimport {\n  flattenFnArray,\n  smellLikeAPromise,\n  validateLifeCyclesFn,\n} from '../lifecycles/helper';\nimport {\n  LOAD_RESOURCE_CODE,\n  MOUNTED,\n  NOT_BOOTSTRAPPED,\n  SKIP_BECAUSE_BROKEN,\n} from '../applications/app.helper';\nimport { ensureAppTimeouts } from '../applications/timeouts';\nimport { toBootstrapPromise } from '../lifecycles/bootstrap';\nimport { toMountPromise } from '../lifecycles/mount';\nimport { toUnmountPromise } from '../lifecycles/unmount';\nimport { toUpdatePromise } from '../lifecycles/update';\n\nlet serviceIndex = 0;\n\nconst systemService = { services: {} };\n\n/**\n * 挂载系统服务\n * @return {{mount(): Promise, unmount(): Promise, update(Object): Promise, getStatus(): string}}\n * @export\n */\nexport function mountSystemService() {\n  return mountService.apply(systemService, arguments);\n}\n\n/**\n * 根据名称获取系统服务\n *\n * @export\n */\nexport function getSystemService(serviceName) {\n  return systemService[serviceName] || {};\n}\n\n/**\n * 挂载服务\n *\n * @export\n * @param {*} config 服务配置或加载函数\n * @param {*} [props={}] 传入服务的属性\n */\nexport function mountService(config, props = {}) {\n  if (!config || !/^(object|function)$/.test(typeof config)) {\n    throw new Error('cannot mount services without config or config load function');\n  }\n\n  const context = this;\n  serviceIndex++;\n\n  let loadServicePromise = typeof config === 'function' ? config() : () => Promise.resolve(config);\n  if (!smellLikeAPromise(loadServicePromise)) {\n    throw new Error('config load function must be a promise or thenable');\n  }\n\n  const service = {\n    id: serviceIndex,\n    // service 支持嵌套\n    services: {},\n    status: LOAD_RESOURCE_CODE,\n    props,\n    context,\n  };\n\n  loadServicePromise = loadServicePromise.then(serviceConfig => {\n    let errorMsg = [];\n    const name = `service: ${service.id}`;\n\n    if (typeof serviceConfig !== 'object') {\n      errorMsg.push(`service load function dose not export anything`);\n    }\n\n    ['bootstrap', 'mount', 'unmount', 'update'].forEach(lifecycle => {\n      // update 是可选的\n      if (lifecycle === 'update' && !serviceConfig[lifecycle]) {\n        return;\n      }\n      if (!validateLifeCyclesFn(serviceConfig[lifecycle])) {\n        errorMsg.push(`service dose not export ${lifecycle} as a function or function array`);\n      }\n    });\n\n    if (errorMsg.length) {\n      service.status = SKIP_BECAUSE_BROKEN;\n      throw new Error(errorMsg.toString());\n    }\n\n    service.name = name;\n    service.status = NOT_BOOTSTRAPPED;\n    service.bootstrap = flattenFnArray(serviceConfig.bootstrap, `service bootstrap functions`);\n    service.mount = flattenFnArray(serviceConfig.mount, `service mount functions`);\n    service.unmount = flattenFnArray(serviceConfig.unmount, `service unmount functions`);\n    service.timeouts = ensureAppTimeouts(serviceConfig.timeouts);\n\n    if (serviceConfig.update) {\n      service.update = flattenFnArray(serviceConfig.update, 'service update function');\n    }\n  });\n\n  loadServicePromise = loadServicePromise.then(() => toBootstrapPromise(service));\n\n  let actions = {\n    mount() {\n      return loadServicePromise.then(() => {\n        context.services[service.name] = service;\n        return toMountPromise(service);\n      }).then(() => {\n        if (service.status !== MOUNTED) {\n          delete context.services[service.name];\n        }\n      });\n    },\n    unmount() {\n      return toUnmountPromise(service).then(() => {\n        delete context.services[service.name];\n      });\n    },\n    update(props = {}) {\n      service.props = props;\n      return toUpdatePromise(service);\n    },\n    getStatus() {\n      return service.status;\n    },\n    getRawData() {\n      return {...service};\n    }\n  };\n\n  service.unmountSelf = actions.unmount;\n  service.mountSelf = actions.mount;\n  service.updateSelf = actions.update;\n\n  return actions;\n}\n\n","'use strict';\n\nimport * as mySingleSpa from '../my-single-spa';\nimport { mountService } from '../services';\n\nexport function getProps(app) {\n  return {\n    ...app.customProps,\n    name: app.name,\n    // 将此方法传入 app 中，让 app 可以在内部自由挂载服务\n    mountService: mountService.bind(app),\n    mySingleSpa,\n  };\n}\n\nexport function smellLikeAPromise(promise) {\n  if (promise instanceof Promise) {\n    return true;\n  }\n\n  return typeof promise === 'object' && promise.then === 'function' && promise.catch === 'function';\n}\n\nexport function validateLifeCyclesFn(fn) {\n  if (typeof fn === 'function') {\n    return true;\n  }\n\n  if (Array.isArray(fn)) {\n    return fn.filter(item => typeof item !== 'function').length === 0;\n  }\n\n  return false;\n}\n\n/**\n * app 的生命周期函数可以传入数组或函数，但是它们必须返回 Promise\n */\nexport function flattenFnArray(fns, description) {\n  // 若传入的不是 Array，则转化为 Array\n  if (!Array.isArray(fns)) {\n    fns = [fns];\n  }\n\n  if (fns.length === 0) {\n    fns = [() => Promise.resolve()];\n  }\n\n  return function (props) {\n    return new Promise((resolve, reject) => {\n      waitForPromises(0);\n\n      function waitForPromises(index) {\n        let fn = fns[index](props);\n        if (!smellLikeAPromise(fn)) {\n          reject(`${description} at index ${index} did not return a promise`);\n          return;\n        }\n        fn.then(() => {\n          if (index === fns.length - 1) {\n            resolve();\n          } else {\n            waitForPromises(++index);\n          }\n        }).catch(e => {\n          reject(e);\n        });\n      }\n    });\n  };\n}","'use strict';\n\nimport {\n  LOAD_ERROR,\n  LOAD_RESOURCE_CODE,\n  NOT_LOADED,\n  SKIP_BECAUSE_BROKEN,\n  NOT_BOOTSTRAPPED,\n} from '../applications/app.helper';\nimport {\n  getProps,\n  smellLikeAPromise,\n  validateLifeCyclesFn,\n  flattenFnArray,\n} from './helper';\nimport { ensureAppTimeouts } from '../applications/timeouts';\n\n/**\n * 加载 app\n *\n * @export\n * @param {*} app\n * @returns\n */\nexport function toLoadPromise(app) {\n  if (app.status !== NOT_LOADED && app.status !== LOAD_ERROR) {\n    return Promise.resolve(app);\n  }\n\n  app.status = LOAD_RESOURCE_CODE;\n\n  const loadPromise = app.loadApp(getProps(app));\n  if (!smellLikeAPromise(loadPromise)) {\n    console.log('app loadFunction must return a promise');\n    app.status = SKIP_BECAUSE_BROKEN;\n    return Promise.resolve(app);\n  }\n\n  return loadPromise.then(module => {\n    let errorMsg = [];\n\n    if (typeof module !== 'object') {\n      errorMsg.push(`app: ${app.name} dose not export anything`);\n    }\n\n    ['bootstrap', 'mount', 'unmount'].forEach(lifecycle => {\n      if (!validateLifeCyclesFn(module[lifecycle])) {\n        errorMsg.push(`app: ${app.name} dose not export ${lifecycle} as a function or function array`);\n      }\n    });\n\n    if (errorMsg.length) {\n      console.log(errorMsg);\n      app.status = SKIP_BECAUSE_BROKEN;\n      return app;\n    }\n\n    app.status = NOT_BOOTSTRAPPED;\n    app.bootstrap = flattenFnArray(module.bootstrap, `app: ${app.name} bootstrap functions`);\n    app.mount = flattenFnArray(module.mount, `app: ${app.name} mount functions`);\n    app.unmount = flattenFnArray(module.unmount, `app: ${app.name} unmount functions`);\n    app.unload = flattenFnArray(module.unload ? module.unload : [], `app: ${app.name} unload functions`);\n    app.timeouts = ensureAppTimeouts(module.timeouts);\n\n    return app;\n  }).catch(e => {\n    console.log(e);\n    app.status = LOAD_ERROR;\n    return app;\n  });\n}","'use strict';\n\nimport { invoke } from './navigation/invoke';\n\nlet started = false;\n\nexport function start() {\n  if (started) {\n    return;\n  }\n\n  started = true;\n  return invoke();\n}\n\nexport function isStarted() {\n  return started;\n}","/**\n * 微前端中 app 分为两种：一种是根据 location 进行变化的，称之为 app；一种是纯功能级别的，称之为 service\n * 要实现根据 location 的变化动态进行 mount 和 unmount 那些符合条件的 app，需要对浏览器的 location 相关操作进行统一拦截\n * 为了在使用Vue、React等视图框架时降低冲突，我们需要保证微前端必须是第一个处理Location的相关事件，然后才是Vue或React等框架的Router处理\n *\n *\n * 为什么Location改变时，微前端框架一定要第一个执行相关操作哪？如何保证\"第一个\"？\n\n * 因为微前端框架要根据Location来对app进行mount或unmount操作。\n * 然后app内部使用的Vue或React才开始真正进行后续工作，这样可以最大程度减少app内部Vue或React的无用（冗余）操作。\n * 对原生的Location相关事件进行拦截（hijack），统一由微前端框架进行控制，这样就可以保证总是第一个执行\n */\n\n'use strict';\n\n// onhashchange onpopstate history.pushState() history.replaceState()\n\nimport { invoke } from './invoke';\n\nconst HIJACK_EVENTS_NAME = /^(hashchange|popstage)$/;\nconst EVENTS_POOL = {\n  hashchange: [],\n  popstage: [],\n};\n\nfunction reroute() {\n  invoke([], arguments);\n}\n\nwindow.addEventListener('hashchange', reroute);\nwindow.addEventListener('popstate', reroute);\n\n// 拦截所以注册的事件，确保这里的事件总是第一个执行\nconst originAddEventListener = window.addEventListener;\nconst originRemoveEventListener = window.removeEventListener;\nwindow.addEventListener = function (eventName, handler, args) {\n  if (eventName && HIJACK_EVENTS_NAME.test(eventName) && typeof handler === 'function') {\n    // 放入队列，等待处理\n    EVENTS_POOL[eventName].indexOf(handler) === -1 && EVENTS_POOL[eventName].push(handler);\n  }\n  return originAddEventListener.apply(this, arguments);\n};\n\nwindow.removeEventListener = function (eventName, handler) {\n  if (eventName && HIJACK_EVENTS_NAME.test(eventName) && typeof handler === 'function') {\n    let eventList = EVENTS_POOL[eventName];\n    eventList.indexOf(handler) > -1 && (EVENTS_POOL[eventName] = eventList.filter(fn => fn !== handler));\n  }\n  originRemoveEventListener.apply(this, arguments);\n};\n\n// 拦截 history 的方法，因为 pushState 和 repalceState方法并不会触发 onpopstate 事件\n// 所以即便我们在 onpopstate时执行了 reroute 方法，也要在这里执行\nconst originHistoryPushState = window.history.pushState;\nconst originHistoryReplaceState = window.history.replaceState;\nwindow.history.pushState = function (state, title, url) {\n  let result = originHistoryPushState.apply(this, arguments);\n  reroute(mockPopStateEvents(state));\n  return result;\n};\nwindow.history.replaceState = function (state, title, url) {\n  let result = originHistoryReplaceState.apply(this, arguments);\n  reroute(mockPopStateEvents(state));\n  return result;\n};\n\nfunction mockPopStateEvents(state) {\n  // 手动触发 popstate\n  return new PopStateEvent('popstate', { state, });\n}\n\nexport function callCapturedEvents(eventArgs) {\n  if (!eventArgs) {\n    return;\n  }\n\n  if (Array.isArray(eventArgs)) {\n    eventArgs = eventArgs[0];\n  }\n  let name = eventArgs.type;\n  if (!HIJACK_EVENTS_NAME.test(name)) {\n    return;\n  }\n  // 执行\n  EVENTS_POOL[name].forEach(handler => handler.apply(window, eventArgs));\n}","'use strict';\n\nimport {\n  getAppsToLoad,\n  getAppsToMount,\n  getAppsToUnmount,\n  getMountedApps,\n} from '../applications/apps';\nimport { toLoadPromise } from '../lifecycles/load';\nimport { toBootstrapPromise } from '../lifecycles/bootstrap';\nimport { toMountPromise } from '../lifecycles/mount';\nimport { toUnmountPromise } from '../lifecycles/unmount';\nimport { isStarted } from '../start';\nimport { callCapturedEvents } from './hijackLocation';\n\nlet loadAppsUnderway = false;\nlet pendingPromises = [];\n\n/**\n * 整个系统的触发机制分为两类\n * 1 浏览器触发：浏览器 location 发生改版，拦截 onhashchange 和 onpopstate 事件，并 mock 浏览器 history 的 pushState 和 replaceState 方法\n * 2 手动触发：手动调用框架的 registerApplication 或 start 方法\n *\n * @export\n * @param {*} pendings\n * @param {*} eventArgs\n * @returns\n */\nexport function invoke(pendings, eventArgs) {\n  if (loadAppsUnderway) {\n    return new Promise((resolve, reject) => {\n      pendingPromises.push({ success: resolve, failure: reject, eventArgs });\n    });\n  }\n\n  loadAppsUnderway = true;\n  if (isStarted()) {\n    // 微前端框架已启动\n    return performAppChanges();\n  }\n  return loadApps();\n\n  // 找到需要 load 的 app\n  function loadApps() {\n    let loadPromises = getAppsToLoad().map(toLoadPromise);\n    return Promise.all(loadPromises).then(() => {\n      callAllLocationEvents();\n      return finish();\n    }).catch(e => {\n      callAllLocationEvents();\n      console.log(e);\n    });\n  }\n\n  // 启动 app\n  function performAppChanges() {\n    // getAppsToUnmount\n    let unmountApps = getAppsToUnmount();\n    let unmountPromises = Promise.all(unmountApps.map(toUnmountPromise));\n\n    // getAppsToLoad\n    let loadApps = getAppsToLoad();\n    let loadPromises = loadApps.map(app => {\n      return toLoadPromise(app)\n        .then(app => toBootstrapPromise(app))\n        .then(() => unmountPromises)\n        .then(() => toMountPromise(app));\n    });\n\n    let mountApps = getAppsToMount().filter(app => loadApps.indexOf(app) === -1);\n    let mountPromises = mountApps.map(app => {\n      return toBootstrapPromise(app).then(() => unmountPromises).then(() => toMountPromise(app));\n    });\n\n    return unmountPromises.then(() => {\n      callAllLocationEvents();\n      let loadAndMountPromises = loadPromises.concat(mountPromises);\n      return Promise.all(loadAndMountPromises).then(finish, ex => {\n        pendings.forEach(item => item.reject(ex));\n        throw ex;\n      });\n    }, e => {\n      callAllLocationEvents();\n      console.log(e);\n      throw e;\n    });\n  }\n\n  function finish() {\n    let resolveValue = getMountedApps();\n    if (pendings) {\n      // pendings 是上一次循环进行时存储的一批 changesQueue 的别名\n      pendings.forEach(item => item.success(resolveValue));\n    }\n\n    // 标记循环已结束\n    loadAppsUnderway = false;\n    if (pendingPromises.length) {\n      const backup = pendingPromises;\n      pendingPromises = [];\n      // 将修改队列传入 invoke 开启下一次循环\n      return invoke(backup);\n    }\n\n    return resolveValue;\n  }\n\n  // 每次循环终止时触发已拦截的 location 事件\n  // 保证微前端框架的 location 触发时机总是首先被执行\n  // 而 Vue 或 React 的 Router 总是在后面执行\n  function callAllLocationEvents() {\n    pendings\n    && pendings.length\n    && pendings.filter(item => item.eventArgs).forEach(item => callCapturedEvents(item.eventArgs));\n    eventArgs && callCapturedEvents(eventArgs);\n  }\n}\n","'use strict';\n\nimport {\n  NOT_LOADED,\n  notSkipped,\n  withoutLoadError,\n  isntLoaded,\n  shouldBeActive,\n  shouldntBeActive,\n  isLoaded,\n  isntActive,\n  isActive,\n} from './app.helper';\nimport { invoke } from '../navigation/invoke';\n\nconst APPS = [];\n\n/**\n * 获取满足加载条件的 app\n * 1 没有加载中断\n * 2 没有加载错误\n * 3 没有被加载过\n * 4 满足 app.activityWhen()\n *\n * @export\n */\nexport function getAppsToLoad() {\n  return APPS.filter(notSkipped).filter(withoutLoadError).filter(isntLoaded).filter(shouldBeActive);\n}\n\n/**\n * 获取需要 mount 的 app\n * 1 没有加载中断\n * 2 加载过的\n * 3 当前没有 mounted 的\n * 4 需要被 mounted 的\n *\n * @export\n */\nexport function getAppsToMount() {\n  return APPS.filter(notSkipped).filter(isLoaded).filter(isntActive).filter(shouldBeActive);\n}\n\n/**\n * 需要被 unmount 的 app\n * 没有加载中断\n * 正在挂着的\n * 需要卸载的\n *\n * @export\n */\nexport function getAppsToUnmount() {\n  return APPS.filter(notSkipped).filter(isActive).filter(shouldntBeActive);\n}\n\n/**\n * 获取所有 app 的名称\n *\n * @export\n */\nexport function getAppNames() {\n  return APPS.map(item => item.name);\n}\n\n/**\n * 获取 app 状态\n *\n * @export\n * @param {*} name\n * @returns\n */\nexport function getAppStatus(name) {\n  if (!name) {\n    return APPS.map(item => item.status);\n  }\n\n  let app = APPS.find(item => item.name === name);\n  return app ? app.status : null;\n}\n\n/**\n * 获取原始 app 数据\n *\n * @export\n * @returns\n */\nexport function getRawApps() {\n  return [...APPS];\n}\n\n/**\n * 获取 mounted 的 app\n *\n * @export\n * @returns\n */\nexport function getMountedApps() {\n  return APPS.filter(isActive).map(item => item.name);\n}\n\n/**\n * 注册 application\n *\n * @export\n * @param {*} appName application 名称\n * @param {*} applicationOrLoadFunction app 配置或 app 异步加载函数\n * @param {*} activityWhen 判断是否应该被挂载\n * @param {*} [customProps={}] 自定义配置\n * @return {Promise}\n */\nexport function registerApplication(appName, applicationOrLoadFunction, activityWhen, customProps = {}) {\n  if (!appName || typeof appName !== 'string') {\n    throw new Error('the app name must be a non-empty string');\n  }\n  if (getAppNames().indexOf(appName) !== -1) {\n    throw new Error(`There is already an app declared with name ${appName}`);\n  }\n  if (typeof customProps !== 'object' || Array.isArray(customProps)) {\n    throw new Error('the customProps must be a pure object');\n  }\n  if (!applicationOrLoadFunction) {\n    throw new Error('the application or load function is required');\n  }\n  if (typeof activityWhen !== 'function') {\n    throw new Error('the activityWhen must be a function');\n  }\n  if (typeof applicationOrLoadFunction !== 'function') {\n    applicationOrLoadFunction = () => Promise.resolve(applicationOrLoadFunction);\n  }\n\n  APPS.push({\n    name: appName,\n    loadApp: applicationOrLoadFunction,\n    activityWhen,\n    customProps,\n    status: NOT_LOADED,\n    services: {},\n  });\n\n  return invoke();\n}"],"names":["DEFAULT_TIMEOUTS","bootstrap","milliseconds","rejectWhenTimeout","mount","unmount","unload","setBootstrapMaxTime","Error","type","setMountMaxTime","setUnmountMaxTime","setUnloadMaxTime","ensureAppTimeouts","timeouts","reasonableTime","promise","description","Promise","resolve","reject","finised","then","data","catch","e","setTimeout","maybeTimeout","error","console","NOT_LOADED","LOAD_RESOURCE_CODE","NOT_BOOTSTRAPPED","BOOTSTRAPPING","NOT_MOUNTED","MOUNTING","MOUNTED","UNMOUNTING","SKIP_BECAUSE_BROKEN","LOAD_ERROR","UPDATING","notSkipped","app","status","withoutLoadError","isLoaded","isntLoaded","isActive","isntActive","shouldBeActive","activityWhen","window","location","shouldntBeActive","toBootstrapPromise","getProps","name","log","toUnmountPromise","unmountThisApp","serviceUnmountError","unmountServicePromise","all","Object","keys","services","map","unmountSelf","toMountPromise","toUpdatePromise","service","update","serviceIndex","systemService","mountSystemService","mountService","apply","arguments","getSystemService","serviceName","config","props","test","context","loadServicePromise","smellLikeAPromise","id","serviceConfig","errorMsg","push","forEach","lifecycle","validateLifeCyclesFn","length","toString","flattenFnArray","actions","getStatus","getRawData","mountSelf","updateSelf","customProps","bind","mySingleSpa","fn","Array","isArray","filter","item","fns","waitForPromises","index","toLoadPromise","loadPromise","loadApp","module","started","start","invoke","isStarted","HIJACK_EVENTS_NAME","EVENTS_POOL","hashchange","popstage","reroute","addEventListener","originAddEventListener","originRemoveEventListener","removeEventListener","eventName","handler","args","indexOf","eventList","originHistoryPushState","history","pushState","originHistoryReplaceState","replaceState","state","title","url","result","mockPopStateEvents","PopStateEvent","callCapturedEvents","eventArgs","loadAppsUnderway","pendingPromises","pendings","success","failure","performAppChanges","loadApps","loadPromises","getAppsToLoad","callAllLocationEvents","finish","unmountApps","getAppsToUnmount","unmountPromises","mountApps","getAppsToMount","mountPromises","loadAndMountPromises","concat","ex","resolveValue","getMountedApps","backup","APPS","getAppNames","getAppStatus","find","getRawApps","registerApplication","appName","applicationOrLoadFunction"],"mappings":"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"}